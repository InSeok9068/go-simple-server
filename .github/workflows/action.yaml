name: Build Go Application

on:
  push:
    branches:
      - release/*

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. ì„œë¹„ìŠ¤ëª… í™˜ê²½ë³€ìˆ˜ ì €ì¥
      - name: Extract Release Name
        run: echo "SERVICE_NAME=$(echo ${GITHUB_REF#refs/heads/release/})" >> $GITHUB_ENV

      # 3. .env í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      - name: Generate .env File
        run: |
          cat <<EOF > .env
            ENV=prod
            CHROMEDP_HEADLESS=true
            GEMINI_AI_KEY=${{ secrets.GEMINI_AI_KEY }}
            OPEN_AI_KEY=${{ secrets.OPEN_AI_KEY }}
            FIREBASE_CONFIG=${{ secrets.FIREBASE_CONFIG }}
            DEBUG_AUTH_PARAM=${{ secrets.DEBUG_AUTH_PARAM }}
            SESSION_SECRET=${{ secrets.SESSION_SECRET }}
            NEW_RELIC_LICENSE_KEY=${{ secrets.NEW_RELIC_LICENSE_KEY }}
          EOF

      # 4. Go ì„¤ì¹˜
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.25

      # 5. Tailwindcss CLI ì„¤ì¹˜
      - name: Install Tailwindcss CLI Dependencies
        run: |
          chmod +x ./task.sh
          ./task.sh install-tailwind linux

      # 6. Tailwindcss Out íŒŒì¼ ìƒì„±
      - name: Tailwindcss Generate
        run: |
          tailwind/tailwindcss -i tailwind/tailwindcss.css -o shared/static/tailwindcss.css  --minify

      # # 7. Lint ì‹¤í–‰
      # - name: golangci-lint
      #   uses: golangci/golangci-lint-action@v6
      #   with:
      #     version: v1.60

      # 8. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ë° ë¹Œë“œ
      - name: Build for Linux
        env:
          GOOS: linux
          GOARCH: amd64
        run: |
          go build -ldflags "-s -w" -o ./${SERVICE_NAME} ./cmd/${SERVICE_NAME}

      # 9. ë°”ì´ë„ˆë¦¬ ì••ì¶•
      - name: Compress Binary
        run: |
          tar -czvf ${SERVICE_NAME}.tar.gz ${SERVICE_NAME}

      # 10. SCP íŒŒì¼ ì „ì†¡ (ì§ì ‘ SCP ì‚¬ìš©)
      - name: Transfer File
        run: |
          echo -e "${{ secrets.REMOTE_SSH_KEY }}" > ssh_key.pem
          chmod 600 ssh_key.pem

          scp -o StrictHostKeyChecking=no -C -i ssh_key.pem -P 22 ./${SERVICE_NAME}.tar.gz ${{ secrets.REMOTE_ID }}@${{ secrets.REMOTE_IP }}:./app

          scp -o StrictHostKeyChecking=no -C -i ssh_key.pem -P 22 ./.env ${{ secrets.REMOTE_ID }}@${{ secrets.REMOTE_IP }}:/tmp/.env.new

          rm ssh_key.pem

      # # 10. SCP íŒŒì¼ ì „ì†¡ (ë¼ì´ë¸Œ ëŸ¬ë¦¬ ì‚¬ìš©) -> ì†ë„ ì´ìŠˆ
      # - name: Deploy File to Server
      #   uses: appleboy/scp-action@master
      #   with:
      #     host: ${{ secrets.REMOTE_IP }}
      #     username: ${{ secrets.REMOTE_ID }}
      #     key: ${{ secrets.REMOTE_SSH_KEY }}
      #     port: 22
      #     source: ./main.tar.gz
      #     target: ./app

      # 11 SSH ëª…ë ¹ì–´ ì‹¤í–‰
      - name: Restart Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_IP }}
          username: ${{ secrets.REMOTE_ID }}
          key: ${{ secrets.REMOTE_SSH_KEY }}
          port: 22
          script: |
            set -euo pipefail

            SERVICE_NAME=${{ env.SERVICE_NAME }}
            APP_DIR=./app
            ENV_TARGET=$APP_DIR/.env
            ENV_TMP=/tmp/.env.new

            cd "$APP_DIR"

            # ë°”ì´ë„ˆë¦¬ ì „ê°œ
            sudo tar -xzvf "${SERVICE_NAME}.tar.gz"
            sudo chmod +x "${SERVICE_NAME}"
            sudo rm -f "${SERVICE_NAME}.tar.gz"

            # .env ë¬´ì¡°ê±´ êµì²´ (ì›í•˜ë©´ ë°±ì—… í•œ ì¤„ ì¶”ê°€)
            if [ -f "$ENV_TMP" ]; then
              # ì„ íƒ) ê¸°ì¡´ .env ë°±ì—…: sudo cp "$ENV_TARGET" "$APP_DIR/.env.bak_$(date +%Y%m%d%H%M%S)" || true
              sudo install -m 600 "$ENV_TMP" "$ENV_TARGET"
              sudo chown root:root "$ENV_TARGET"
              sudo rm -f "$ENV_TMP"
              echo "Replaced .env"
            else
              echo "No /tmp/.env.new uploaded; skipping env replace."
            fi

            # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            sudo systemctl restart "${SERVICE_NAME}.service"
            echo "Restarted ${SERVICE_NAME}.service"

      # 12. ì»¤ë°‹ ë©”ì‹œì§€ ì¤€ë¹„ (í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ê¸¸ì´ ì œí•œ í•´ê²°)
      - name: Prepare Commit Message
        id: prep_commit
        run: echo "commit_message=$(echo "${{ github.event.head_commit.message }}" | head -n 1 | cut -c -200)" >> $GITHUB_OUTPUT

      # 13-1. ë¹Œë“œ ì„±ê³µ ë©”ì„¸ì§€ ë°œì†¡
      - name: Send Build Success Message
        uses: appleboy/telegram-action@master
        if: success()
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            Status: ğŸ˜š **Success**

            Branch: ${{ github.ref_name }}

            Commit message: ${{ steps.prep_commit.outputs.commit_message }}

            [See changes](https://github.com/${{ github.repository }}/commit/${{github.sha}})

      # 13-2. ë¹Œë“œ ì‹¤íŒ¨ ë©”ì„¸ì§€ ë°œì†¡
      - name: Send Build Failure Message
        uses: appleboy/telegram-action@master
        if: failure()
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            Status: ğŸ˜± **Failure**

            Branch: ${{ github.ref_name }}

            Commit message: ${{ steps.prep_commit.outputs.commit_message }}

            [link](https://github.com/${{ github.repository }}/actions)

# Repository: ${{ github.repository }}
# Author: ${{github.actor}}
