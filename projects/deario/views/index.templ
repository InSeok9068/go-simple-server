package views

import (
        "fmt"
        "time"

        "simple-server/pkg/util/dateutil"
        "simple-server/projects/deario/views/layout"
        shared "simple-server/shared/views"
)

templ Index(title string, date string, mood string) {
        <!DOCTYPE html>
        <html lang="ko">
                <head>
                        @shared.HeadsWithBeerTempl(title)
                        @shared.HeadsWithFirebaseAuthTempl()
                        @shared.HeadsWithGoogleFontsTempl("Gamja Flower")
                        <meta name="description" content="AI í”¼ë“œë°± ì¼ê¸° ì„œë¹„ìŠ¤"/>
                        <link rel="manifest" href="/manifest.json"/>
                        <script src="/static/deario.js"></script>
                        <script src="/static/calendar.js"></script>
                        <script src="/static/voice.js"></script>
                        <script type="module" src="/static/storage.js"></script>
                </head>
                <body>
                        @shared.SnackbarTempl()
                        @layout.AppHeader()
                        <main id="diary-main">
                                <nav>
                                        <a id="prev-day" href={ fmt.Sprintf("/?date=%s", dateutil.MustAddDaysToDate(date, -1)) }>
                                                <i>arrow_back_ios</i>
                                        </a>
                                        <a id="today-day" href={ fmt.Sprintf("/?date=%s", time.Now().Format("20060102")) }>
                                                <button class="small-round small">Today</button>
                                        </a>
                                        <a id="next-day" href={ fmt.Sprintf("/?date=%s", dateutil.MustAddDaysToDate(date, 1)) }>
                                                <i>arrow_forward_ios</i>
                                        </a>
                                        <button class="chip" data-ui="#calendar-dialog">
                                                <i>calendar_month</i>
                                                <span class="bold">{ DateView(date) }</span>
                                        </button>
                                        <div class="max"></div>
                                        <i x-data="" x-text="$store.save.isOk ? 'check' : 'sync'"></i>
                                </nav>
                                <hr class="medium"/>
                                <form hx-get="/diary" hx-target="#diary" hx-trigger="load" hx-swap="outerHTML">
                                        <input type="hidden" name="date" value={ date }/>
                                </form>
                                @DiaryContentForm(date, "")
                                <nav>
                                        <p class="bold">í•˜ë£¨ì˜ ê¸°ë¶„ì„ ì•„ì´ì½˜ìœ¼ë¡œ í‘œí˜„í•´ì£¼ì„¸ìš” âœ…</p>
                                </nav>
                                <nav>
                                        <div x-data={ fmt.Sprintf("{ mood: '%s' }", mood) }>
                                                <form
                                                        hx-post="/diary/mood"
                                                        hx-swap="none"
                                                        hx-on:htmx:after-on-load="if (event.detail.successful) showInfo('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.')"
                                                >
                                                        <input type="hidden" name="date" value={ date }/>
                                                        <input type="hidden" name="mood" x-model="mood"/>
                                                        <button class="chip circle" :class="mood === '1' ? 'primary' : ''" x-on:click="mood = '1'" type="button">
                                                                <i>sentiment_very_satisfied</i>
                                                        </button>
                                                        <button class="chip circle" :class="mood === '2' ? 'primary' : ''" x-on:click="mood = '2'" type="button">
                                                                <i>sentiment_satisfied</i>
                                                        </button>
                                                        <button class="chip circle" :class="mood === '3' ? 'primary' : ''" x-on:click="mood = '3'" type="button">
                                                                <i>sentiment_neutral</i>
                                                        </button>
                                                        <button class="chip circle" :class="mood === '4' ? 'primary' : ''" x-on:click="mood = '4'" type="button">
                                                                <i>sentiment_frustrated</i>
                                                        </button>
                                                        <button class="chip circle" :class="mood === '5' ? 'primary' : ''" x-on:click="mood = '5'" type="button">
                                                                <i>sentiment_extremely_dissatisfied</i>
                                                        </button>
                                                </form>
                                        </div>
                                </nav>
                                <nav>
                                        <button class="chip" data-ui="#cbt-dialog">
                                                <i>psychology_alt</i>
                                                CBT
                                        </button>
                                        <button class="chip" data-ui="#diary-image-dialog">
                                                <i>image</i>
                                                ì´ë¯¸ì§€
                                        </button>
                                        <div class="max"></div>
                                        <img id="feedback-loading" class="htmx-indicator" src="/shared/static/spinner.svg" alt="ë¡œë”©"/>
                                        <nav class="min active">
                                                <button data-ui="#ai-feedback">
                                                        <span>ì¼ê¸°ìš”ì •</span>
                                                </button>
                                                <menu class="top transparent no-wrap left right-align" id="ai-feedback" data-ui="#ai-feedback">
                                                        @aiFeedbackButton("1", "ì¹­ì°¬ë°›ê¸°")
                                                        @aiFeedbackButton("2", "ìœ„ë¡œë°›ê¸°")
                                                        @aiFeedbackButton("3", "ì¶©ê³ ë°›ê¸°")
                                                        @aiFeedbackButton("4", "ê·¸ë¦¼ì¼ê¸°")
                                                        <li hx-get={ "/ai-feedback?date=" + date } hx-target="#ai-feedback-content" hx-on:htmx:after-on-load="if (event.detail.successful) showAiFeedback()">
                                                                <button class="fill">
                                                                        <span>ë‹¤ì‹œë³´ê¸°</span>
                                                                </button>
                                                        </li>
                                                </menu>
                                        </nav>
                                </nav>
                        </main>
                        <nav class="bottom">
                                <a href="#" data-ui="#calendar-dialog">
                                        <i>calendar_month</i>
                                        ë‹¬ë ¥
                                </a>
                                <a href="#" data-ui="#diary-list-dialog">
                                        <i>list_alt</i>
                                        ì¼ì§€
                                </a>
                                <a href="/diary/random" hx-get="/diary/random">
                                        <i>casino</i>
                                        ëœë¤
                                </a>
                                <a href="#" data-ui="#menu-dialog">
                                        <i>menu_open</i>
                                        ë©”ë‰´
                                </a>
                        </nav>
                        <dialog id="cbt-dialog" class="max">
                                <h5>CBT ì¸ì§€í–‰ë™ì¹˜ë£Œ</h5>
                                <nav>
                                        <a class="link" href="https://gemini.google.com/gem/3ddb44f68f79">Gemini CBT Gemìœ¼ë¡œ ì´ë™í•˜ê¸°</a>
                                </nav>
                                <p class="bold">CBT ì¼ê¸°</p>
                                <ul class="list no-space">
                                        <li>
                                                ë– ì˜¤ë¥¸ ìƒê°: ì˜¤ëŠ˜ ë‚˜ë¥¼ í˜ë“¤ê²Œ í•œ ìë™ì  ì‚¬ê³ ë¥¼ ì ê¸°<br/>
                                                ğŸ‘‰ ë°œí‘œ ë§ì³¤ì–´ ë‚œ ë°”ë³´ì•¼
                                        </li>
                                        <li>
                                                ìƒê° ê²€í† : ê·¸ ìƒê°ì´ ì§„ì§œì¸ì§€, ë‹¤ë¥¸ ê´€ì ì€ ì—†ëŠ”ì§€ ë¬»ê¸°<br/>
                                                ğŸ‘‰ ì •ë§ ë‹¤ ë§ì³¤ë‚˜? ì˜í•œ ê±´ ì—†ì–´?
                                        </li>
                                        <li>
                                                ìƒˆë¡œìš´ ìƒê°: ë” ë‚˜ì€ ë°©ì‹ìœ¼ë¡œ ë‹¤ë¥´ê²Œ ìƒê°í•´ë³´ê¸°<br/>
                                                ğŸ‘‰ ì•„ì‰¬ìš´ ì ë„ ìˆì—ˆì§€ë§Œ, ë‹¤ìŒì—” ë” ì˜í• ê±°ì•¼
                                        </li>
                                </ul>
                                <hr/>
                                <nav></nav>
                                <p class="bold">ëŒ€í™” ìê¸° ì ê²€</p>
                                <ul class="list no-space">
                                        <li>
                                                ê°ì • ì¸ì •: ìƒëŒ€ ê°ì •ì„ ì¶©ë¶„íˆ ë°›ì•„ì¤¬ëŠ”ê°€<br/>
                                                ğŸ‘‰ ë§ì´ í˜ë“¤ì—ˆê² ë„¤
                                        </li>
                                        <li>
                                                ìˆ¨ì€ ì˜ë„: ë§ ë’¤ì˜ ê°ì •/ì˜ë„ë¥¼ ì¶”ì¸¡í–ˆëŠ”ê°€<br/>
                                                ğŸ‘‰ í˜¹ì‹œ í”¼ê³¤í•´ì„œ ì˜ˆë¯¼í•œ ê±´ê°€?
                                        </li>
                                        <li>
                                                íŒë‹¨/ë³€ëª…: ë‚´ ìŠ¤ìŠ¤ë¡œ íŒë‹¨í•˜ê±°ë‚˜ ë³€ëª…í•˜ì§€ ì•Šì•˜ëŠ”ê°€<br/>
                                                ğŸ‘‰ ë„¤ê°€ ì„œìš´í–ˆê² ë„¤. ë¯¸ì•ˆí•´ (ë³€ëª… X)
                                        </li>
                                </ul>
                                <nav class="right-align">
                                        <button data-ui="#cbt-dialog">ë‹«ê¸°</button>
                                </nav>
                        </dialog>
                        <dialog id="ai-feedback-dialog" class="max">
                                <h5>ì¼ê¸° ìš”ì •</h5>
                                <form>
                                        <input type="hidden" name="date" value={ date }/>
                                        <div id="ai-feedback-content">ì•ˆë…•</div>
                                        <nav class="right-align">
                                                <button
                                                        class="border"
                                                        hx-post="/ai-feedback/save?"
                                                        hx-swap="none"
                                                        hx-on:htmx:after-on-load="if (event.detail.successful) closeModal('#ai-feedback-dialog'); showInfo('ì €ì¥ ë˜ì—ˆìŠµë‹ˆë‹¤.')"
                                                >
                                                        <i>save</i>
                                                        <span>ì €ì¥</span>
                                                </button>
                                                <button type="button" onclick="closeModal('#ai-feedback-dialog')">ë‹«ê¸°</button>
                                        </nav>
                                </form>
                        </dialog>
                        <dialog id="calendar-dialog" class="bottom">
                                <h5>ë‹¬ë ¥</h5>
                                <div class="space"></div>
                                <div id="calendar-picker"></div>
                                <nav class="right-align">
                                        <button data-ui="#calendar-dialog">ë‹«ê¸°</button>
                                </nav>
                        </dialog>
                        <dialog id="diary-image-dialog" class="bottom">
                                <h5>ì´ë¯¸ì§€</h5>
                                <div hx-get={ fmt.Sprintf("/diary/images?date=%s", date) } hx-trigger="load"></div>
                                <div class="space"></div>
                                <button>
                                        <i>attach_file</i>
                                        File
                                        <input type="file" accept="image/*" id="diary-image-file" onchange="previewDiaryImage(this)"/>
                                </button>
                                <nav class="right-align">
                                        <img id="diary-image-loading" src="/shared/static/spinner.svg" style="display:none" alt="ë¡œë”©"/>
                                        <button type="button" onclick={ fmt.Sprintf("uploadDiaryImage('%s')", date) }>ì—…ë¡œë“œ</button>
                                </nav>
                                <nav class="right-align">
                                        <button data-ui="#diary-image-dialog">ë‹«ê¸°</button>
                                </nav>
                        </dialog>
                        <dialog id="diary-list-dialog" class="max">
                                <h5>ì‘ì„± ì¼ì§€</h5>
                                <ul id="diary-list-content" class="list border"></ul>
                                <div x-data="{ page : 1 }">
                                        <nav class="center-align">
                                                <button
                                                        hx-get="/diary/list"
                                                        hx-target="#diary-list-content"
                                                        hx-trigger="load delay:0.5s, click"
                                                        hx-swap="beforeend"
                                                        @click="page++"
                                                        :hx-vals="JSON.stringify({ page: page })"
                                                >
                                                        <i>arrow_drop_down</i>
                                                </button>
                                        </nav>
                                        <nav class="right-align">
                                                <button data-ui="#diary-list-dialog">ë‹«ê¸°</button>
                                        </nav>
                                </div>
                        </dialog>
                        <dialog id="menu-dialog" class="right">
                                <h5>ë©”ë‰´</h5>
                                <ul class="list">
                                        <li class="wave round">
                                                <a href="/statistic">
                                                        <i>monitoring</i>
                                                        í†µê³„
                                                </a>
                                        </li>
                                        <li class="wave round">
                                                <a href="/setting">
                                                        <i>settings</i>
                                                        ì„¤ì •
                                                </a>
                                        </li>
                                        <li class="wave round">
                                                <a href="/privacy">
                                                        <i>admin_panel_settings</i>
                                                        ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨
                                                </a>
                                        </li>
                                </ul>
                                <nav class="right-align">
                                        <button data-ui="#menu-dialog">ë‹«ê¸°</button>
                                </nav>
                        </dialog>
                </body>
        </html>
}

templ DiaryContentForm(date string, content string) {
        <form id="diary">
                <input type="hidden" name="date" value={ date }/>
                <div class="field textarea border u-fit-h-18rem">
                        <textarea
                                name="content"
                                autofocus
                                x-data=""
                                hx-post="/diary/save"
                                hx-swap="none"
                                hx-trigger="input delay:0.5s"
                                @input="$store.save.unok()"
                                @htmx:after-request="$store.save.ok()"
                                aria-label="ì¼ê¸° ë‚´ìš©"
                                placeholder="ì˜¤ëŠ˜ì˜ ì¼ê¸°ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        >{ content }</textarea>
                </div>
                <button type="button" class="chip circle microphone" onclick="toggleRecord(this)">
                        <i>mic</i>
                </button>
        </form>
}

templ aiFeedbackButton(strType string, title string) {
        <li
                hx-post={ fmt.Sprintf("/ai-feedback?type=%s", strType) }
                hx-include="[name='content']"
                hx-target="#ai-feedback-content"
                hx-indicator="#feedback-loading"
                hx-on:htmx:after-on-load="if (event.detail.successful) showAiFeedback()"
        >
                <button class="fill">
                        <span>{ title }</span>
                </button>
        </li>
}
